<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Porchlight Euchre Club Admin</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 2rem;
      color: #222;
    }
    h1, h2, h3 {
      color: #275f49;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 700px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #e4f2d4;
      color: #275f49;
    }
    .form-box {
      margin-top: 2rem;
      background: #fff;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 700px;
    }
    input, select {
      padding: 6px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #275f49;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover {
      background: #1e4a39;
    }
    .hidden { display: none; }
    .team-card {
      display: inline-block;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      margin: 5px;
      width: 200px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Porchlight Euchre Club — Admin Panel</h1>

  <div class="form-box">
    <h2>Game Night Setup</h2>
    <label>Date:</label>
    <input type="date" id="nightDate"><br>
    <div id="playerCheckList"></div>
    <button onclick="planNight()">Plan Game Night</button>
    <button id="confirmBtn" class="hidden" onclick="confirmNight()">Confirm & Start Night</button>
    <button id="cancelBtn" class="hidden" onclick="cancelNight()">Cancel Night</button>
    <button id="endBtn" class="hidden" onclick="endNight()">End Night</button>
    <div id="nightStatusMsg" style="margin-top:0.5rem; color:#275f49;"></div>
  </div>

  <div id="plannedMatchesBox" class="form-box hidden">
    <h3>Planned Teams & Matchups</h3>
    <div id="plannedMatches"></div>
  </div>

  <hr>

  <h2>Leaderboard</h2>
  <table id="leaderboard">
    <thead>
      <tr><th>Player</th><th>Wins</th><th>Losses</th><th>Points</th></tr>
    </thead>
    <tbody id="leaderboard-body">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>

  <script>
    const AIRTABLE_TOKEN = 'patRbdM5rKU2gtz83.82c10c403e9f183593e2b2492d93a8bd78600eb4e4bdbe88a7c6318c34486d22';
    const AIRTABLE_BASE  = 'appiiakeJWvHtrd2h';
    const PLAYERS_TABLE  = 'players';
    const MATCHES_TABLE  = 'matches';
    const NIGHTS_TABLE   = 'nights';
    const authHeader = { Authorization: `Bearer ${AIRTABLE_TOKEN}` };

    let playerMap = {};
    let currentNight = null;
    let plannedTeams = [];

    // === LOAD PLAYERS ===
    async function loadPlayers() {
  const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${PLAYERS_TABLE}`;
  const res = await fetch(url, { headers: authHeader });

  if (!res.ok) {
    console.error("❌ Airtable fetch failed", res.status, await res.text());
    document.getElementById('leaderboard-body').innerHTML =
      `<tr><td colspan="4" style="text-align:center;color:red;">Airtable fetch failed (${res.status})</td></tr>`;
    return;
  }

  const data = await res.json();
  if (!data.records || data.records.length === 0) {
    document.getElementById('leaderboard-body').innerHTML =
      `<tr><td colspan="4" style="text-align:center;">No players found</td></tr>`;
    return;
  }

  const tbody = document.getElementById('leaderboard-body');
  tbody.innerHTML = '';
  playerMap = {};

  data.records.forEach(r => {
    playerMap[r.id] = r.fields.name;
    const f = r.fields;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${f.name}</td><td>${f.wins||0}</td><td>${f.losses||0}</td><td>${f.points||0}</td>`;
    tbody.appendChild(tr);
  });

  const list = document.getElementById('playerCheckList');
  list.innerHTML = '<strong>Select players:</strong><br>';
  data.records.forEach(r=>{
    const f=r.fields;
    const label=document.createElement('label');
    label.innerHTML=`<input type="checkbox" class="playerCheck" value="${r.id}"> ${f.name}<br>`;
    list.appendChild(label);
  });
}


    // === PLAN NIGHT ===
    async function planNight() {
      const selected = [...document.querySelectorAll('.playerCheck:checked')].map(c => c.value);
      if (selected.length < 4) return alert('Select at least 4 players.');
      const date = document.getElementById('nightDate').value || new Date().toISOString().slice(0,10);

      // Create planned night
      const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${NIGHTS_TABLE}`, {
        method: 'POST',
        headers: {...authHeader,'Content-Type':'application/json'},
        body: JSON.stringify({fields:{date,status:'planned',attendees:selected}})
      });
      const night = await res.json();
      currentNight = night.id;

      // Create teams
      plannedTeams = shuffleArray(selected).reduce((acc,_,i,arr)=>{
        if(i%2===0) acc.push(arr.slice(i,i+2));
        return acc;
      },[]);
      displayPlannedMatches();

      document.getElementById('plannedMatchesBox').classList.remove('hidden');
      document.getElementById('confirmBtn').classList.remove('hidden');
      document.getElementById('cancelBtn').classList.remove('hidden');
      document.getElementById('nightStatusMsg').innerText='Night planned but not started.';
    }

    // === CONFIRM NIGHT ===
    async function confirmNight() {
      const colors = ['Red','Blue','Green','Yellow','Purple','Orange','Pink','Black','White'];
      const teamColors = plannedTeams.map((_,i)=>colors[i%colors.length]);
      const matchups = [];
      for (let i=0; i<plannedTeams.length; i++) {
        for (let j=i+1; j<plannedTeams.length; j++) {
          matchups.push({
            teamA: plannedTeams[i],
            teamB: plannedTeams[j],
            colorA: teamColors[i],
            colorB: teamColors[j]
          });
        }
      }

      // Update night to in progress
      await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${NIGHTS_TABLE}/${currentNight}`,{
        method:'PATCH',headers:{...authHeader,'Content-Type':'application/json'},
        body:JSON.stringify({fields:{status:'in progress'}})
      });

      // Write matches
      for (const m of matchups) {
        await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${MATCHES_TABLE}`,{
          method:'POST',
          headers:{...authHeader,'Content-Type':'application/json'},
          body:JSON.stringify({fields:{
            ts:new Date().toISOString(),
            nights:[currentNight],
            teamA1:[m.teamA[0]],teamA2:[m.teamA[1]],
            teamB1:[m.teamB[0]],teamB2:[m.teamB[1]],
            teamNames:`Team ${m.colorA} vs Team ${m.colorB}`,
            winner:'',winPts:1,status:'pending'
          }})
        });
      }

      document.getElementById('nightStatusMsg').innerText='Game Night in progress!';
      document.getElementById('confirmBtn').classList.add('hidden');
      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('endBtn').classList.remove('hidden');
    }

    // === CANCEL NIGHT ===
    async function cancelNight() {
      if(!currentNight) return;
      await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${NIGHTS_TABLE}/${currentNight}`,{
        method:'DELETE',headers:authHeader});
      document.getElementById('nightStatusMsg').innerText='Night cancelled.';
      resetNightUI();
    }

    // === END NIGHT ===
    async function endNight() {
      if(!currentNight) return;
      await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${NIGHTS_TABLE}/${currentNight}`,{
        method:'PATCH',headers:{...authHeader,'Content-Type':'application/json'},
        body:JSON.stringify({fields:{status:'complete'}})
      });
      document.getElementById('nightStatusMsg').innerText='Night completed!';
      resetNightUI();
    }

    // === DISPLAY PLANNED MATCHES ===
    function displayPlannedMatches() {
      const div = document.getElementById('plannedMatches');
      div.innerHTML = '';
      for (let i=0; i<plannedTeams.length; i++) {
        const t = plannedTeams[i].map(p=>playerMap[p]).join(' & ');
        div.innerHTML += `<div class="team-card"><strong>Team ${i+1}</strong><br>${t}</div>`;
      }
    }

    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function resetNightUI(){
      document.getElementById('plannedMatchesBox').classList.add('hidden');
      document.getElementById('confirmBtn').classList.add('hidden');
      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('endBtn').classList.add('hidden');
      currentNight=null;
      plannedTeams=[];
    }

    loadPlayers();
  </script>
</body>
</html>
