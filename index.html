<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Euchre Club Leaderboard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f8f9f8;
      margin: 0;
      padding: 2rem;
      color: #222;
    }
    h1, h2 {
      color: #275f49;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 700px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #e4f2d4;
      color: #275f49;
    }
    .form-box {
      margin-top: 2rem;
      background: #fff;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    input[type=text], select, input[type=number] {
      width: 70%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #275f49;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover {
      background: #1e4a39;
    }
    hr {
      margin: 3rem 0 2rem;
    }
  </style>
</head>
<body>
  <h1>Euchre Club Leaderboard</h1>

  <table id="leaderboard">
    <thead>
      <tr>
        <th>Player</th>
        <th>Wins</th>
        <th>Losses</th>
        <th>Points</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>

  <div class="form-box">
    <h3>Add Player</h3>
    <input type="text" id="playerName" placeholder="Enter name" required />
    <button onclick="addPlayer()">Add Player</button>
  </div>

  <hr>

  <h2>Match History</h2>
  <table id="matches">
    <thead>
      <tr>
        <th>Date</th>
        <th>Team A</th>
        <th>Team B</th>
        <th>Winner</th>
        <th>Points</th>
      </tr>
    </thead>
    <tbody id="matches-body">
      <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>

  <div class="form-box">
    <h3>Add Match</h3>
    <label>Team A:</label><br>
    <select id="teamA1"></select>
    <select id="teamA2"></select><br>

    <label>Team B:</label><br>
    <select id="teamB1"></select>
    <select id="teamB2"></select><br>

    <label>Winner:</label><br>
    <select id="winner">
      <option value="">Select Winner</option>
      <option value="A">Team A</option>
      <option value="B">Team B</option>
    </select><br>

    <label>Points:</label><br>
    <input type="number" id="points" value="1" min="1" /><br>

    <button onclick="addMatch()">Record Match</button>
  </div>

  <script>
    // ===== CONFIG =====
    const AIRTABLE_TOKEN = 'patiQbXhhcauYwsQM.84bc62b2b9a1edc32ac38cce6846ce03d7c7a4b6fa6bca7cb141e0e75722ff97';   // your token
    const AIRTABLE_BASE  = 'appiiakeJWvHtrd2h';   // your base ID
    const PLAYERS_TABLE  = 'players';           // lowercase table
    const MATCHES_TABLE  = 'matches';           // lowercase table

    // ===== LOAD PLAYERS =====
    async function loadPlayers() {
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${PLAYERS_TABLE}?sort[0][field]=points&sort[0][direction]=desc`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }});
      const data = await res.json();
      const tbody = document.getElementById('leaderboard-body');
      tbody.innerHTML = '';

      if (!data.records || data.records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No players yet.</td></tr>';
        return;
      }

      // Fill leaderboard
      data.records.forEach(r => {
        const f = r.fields;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${f.name || ''}</td>
          <td>${f.wins ?? 0}</td>
          <td>${f.losses ?? 0}</td>
          <td>${f.points ?? 0}</td>
        `;
        tbody.appendChild(row);
      });

      // Fill dropdowns
      // Fill dropdowns with player name + ID
      const selects = [teamA1, teamA2, teamB1, teamB2];
      selects.forEach(sel => {
        sel.innerHTML = '<option value="">--Select--</option>';
        data.records.forEach(r => {
          const f = r.fields;
          const opt = document.createElement('option');
          opt.value = r.id;        // store the record ID
          opt.textContent = f.name; // show name to user
          sel.appendChild(opt);
        });
      });

    }

    // ===== ADD PLAYER =====
    async function addPlayer() {
      const nameInput = document.getElementById('playerName');
      const name = nameInput.value.trim();
      if (!name) return;
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${PLAYERS_TABLE}`;
      const body = { fields: { name, wins: 0, losses: 0, points: 0 }};
      await fetch(url, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${AIRTABLE_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      nameInput.value = '';
      await loadPlayers();
    }

    // ===== LOAD MATCHES =====
async function loadMatches() {
  const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${MATCHES_TABLE}?sort[0][field]=ts&sort[0][direction]=desc`;
  const res = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }});
  const data = await res.json();
  const tbody = document.getElementById('matches-body');
  tbody.innerHTML = '';

  if (!data.records || data.records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No matches yet.</td></tr>';
    return;
  }

  data.records.forEach(r => {
    const f = r.fields;
    const row = document.createElement('tr');
    const dateStr = f.ts ? new Date(f.ts).toLocaleDateString() : '';
    row.innerHTML = `
      <td>${dateStr}</td>
      <td>${f.teamA1 || ''}, ${f.teamA2 || ''}</td>
      <td>${f.teamB1 || ''}, ${f.teamB2 || ''}</td>
      <td>${f.winner || ''}</td>
      <td>${f.winPts ?? 0}</td>
    `;
    tbody.appendChild(row);
  });
}

    // ===== ADD MATCH =====
    async function addMatch() {
        const a1 = teamA1.value, a2 = teamA2.value, b1 = teamB1.value, b2 = teamB2.value;
        const winner = document.getElementById('winner').value;
        const points = Number(document.getElementById('points').value) || 1;
      
        if (!a1 || !a2 || !b1 || !b2 || !winner) {
          alert('Please select all players and a winner.');
          return;
        }
      
        // STEP 1: Add match to Airtable (store player IDs)
        const matchUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${MATCHES_TABLE}`;
        const matchBody = {
          fields: {
            ts: new Date().toISOString(),
            teamA1: [a1],
            teamA2: [a2],
            teamB1: [b1],
            teamB2: [b2],
            winner,
            bonus: 0,
            winPts: points
          }
        };
      
        const matchRes = await fetch(matchUrl, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${AIRTABLE_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(matchBody)
        });
      
        const matchData = await matchRes.json();
        console.log('Match added:', matchData);
      
        // STEP 2: Update player stats directly by ID
        const winners = winner === 'A' ? [a1, a2] : [b1, b2];
        const losers  = winner === 'A' ? [b1, b2] : [a1, a2];
      
        await updatePlayerStats(winners, 'win', points);
        await updatePlayerStats(losers, 'loss', 0);
      
        await loadPlayers();
        await loadMatches();
        document.getElementById('winner').value = '';
        document.getElementById('points').value = 1;
      }

 // ===== HELPER FUNCTION TO UPDATE STATS =====
async function updatePlayerStats(playerIds, result, pts) {
  const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${PLAYERS_TABLE}`;

  for (const recId of playerIds) {
    // Fetch the specific player record
    const res = await fetch(`${url}/${recId}`, {
      headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
    });
    const data = await res.json();

    if (!data.fields) {
      console.warn('Player record not found for ID:', recId);
      continue;
    }

    const f = data.fields;
    const wins   = parseInt(f.wins   ?? 0);
    const losses = parseInt(f.losses ?? 0);
    const points = parseInt(f.points ?? 0);

    const update = {
      fields: {
        wins: result === 'win'  ? wins + 1   : wins,
        losses: result === 'loss' ? losses + 1 : losses,
        points: result === 'win'  ? points + pts : points
      }
    };

    const patchRes = await fetch(`${url}/${recId}`, {
      method: 'PATCH',
      headers: {
        Authorization: `Bearer ${AIRTABLE_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(update)
    });

    const patchData = await patchRes.json();
    console.log(`Updated ${recId}:`, patchRes.status, patchData);
  }
}


    // ===== INITIAL LOAD =====
    loadPlayers();
    loadMatches();
  </script>
</body>
</html>
