<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Euchre Club ‚Äî Live Leaderboard</title>
  <style>
    body {
      font-family: 'Poppins', system-ui, sans-serif;
      background: radial-gradient(circle at center, #173d2f 0%, #0f261e 100%);
      color: #fff;
      margin: 0;
      padding: 2rem;
      text-align: center;
      overflow-x: hidden;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #e4f2d4;
      text-shadow: 0 0 10px #44ff9a;
    }
    .section {
      margin: 2rem auto;
      max-width: 900px;
      background: rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    .match-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
    }
    .match-card {
      background: #1c3c2f;
      border-radius: 16px;
      padding: 1rem 1.2rem;
      min-width: 200px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      border: 2px solid #44ff9a;
      transition: transform 0.25s, box-shadow 0.25s;
    }
    .match-card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px rgba(0,255,200,0.6);
    }
    .team-name {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    .vs {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .status {
      margin-top: 0.4rem;
      font-size: 0.9rem;
    }
    .leaderboard table {
      border-collapse: collapse;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(6px);
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    th {
      background: rgba(255,255,255,0.2);
      color: #e4f2d4;
    }
    tr:hover {
      background: rgba(255,255,255,0.1);
    }
    footer {
      margin-top: 2rem;
      font-size: 0.8rem;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>üÉè Euchre Club Live</h1>

  <div id="night-status" class="section">Loading game info...</div>
  <div id="matches" class="section"></div>

  <div class="section leaderboard">
    <h2>üèÜ Leaderboard</h2>
    <table id="leaderboard">
      <thead><tr><th>Player</th><th>Wins</th><th>Losses</th><th>Points</th></tr></thead>
      <tbody id="leaderboard-body"><tr><td colspan="4">Loading...</td></tr></tbody>
    </table>
  </div>

  <footer>üíö Euchre Club ‚Ä¢ Updated live from Airtable</footer>

  <script>
    const AIRTABLE_TOKEN = 'patp2kWXmK7Vc5SXF.e60aa4c97a0f1b03640614a30e154f0047d14829803c841dee4ca1cdf828594d';
    const AIRTABLE_BASE  = 'appiiakeJWvHtrd2h';
    const PLAYERS_TABLE  = 'players';
    const MATCHES_TABLE  = 'matches';
    const NIGHTS_TABLE   = 'nights';
    const authHeader = { Authorization: `Bearer ${AIRTABLE_TOKEN}` };

    const COLORS = ['#ff4d4d','#ffa94d','#ffee58','#4caf50','#2196f3','#9c27b0','#ff80ab','#333','#fff'];

    async function fetchTable(table) {
      try {
        const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE}/${table}`, { headers: authHeader });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error(`Error fetching ${table}:`, err);
        return { records: [] };
      }
    }

    async function loadLeaderboard() {
      const data = await fetchTable(PLAYERS_TABLE);
      const tbody = document.getElementById('leaderboard-body');
      tbody.innerHTML = '';
      if (!data.records?.length) {
        tbody.innerHTML = '<tr><td colspan="4">No players found</td></tr>';
        return;
      }
      data.records.sort((a,b)=>(b.fields.points||0)-(a.fields.points||0))
        .forEach(r=>{
          const f=r.fields;
          tbody.insertAdjacentHTML('beforeend',
            `<tr><td>${f.name||''}</td><td>${f.wins||0}</td><td>${f.losses||0}</td><td>${f.points||0}</td></tr>`);
        });
    }

async function loadGameNight() {
  // 1Ô∏è‚É£ fetch everything with full safety wrappers
  let nightData = {}, matchData = {}, playerData = {};
  try {
    const nRes = await fetch(
      `https://api.airtable.com/v0/${AIRTABLE_BASE}/${NIGHTS_TABLE}?filterByFormula=${encodeURIComponent("{status}='in progress'")}`,
      { headers: authHeader }
    );
    nightData = await nRes.json();
  } catch (e) {
    console.error("‚ùå Nights fetch failed:", e);
    nightData = { records: [] };
  }

  try {
    matchData = await fetchTable(MATCHES_TABLE);
  } catch (e) {
    console.error("‚ùå Matches fetch failed:", e);
    matchData = { records: [] };
  }

  try {
    playerData = await fetchTable(PLAYERS_TABLE);
  } catch (e) {
    console.error("‚ùå Players fetch failed:", e);
    playerData = { records: [] };
  }

  const playerMap = {};
  if (Array.isArray(playerData.records)) {
    playerData.records.forEach(p => playerMap[p.id] = p.fields?.name || "(unnamed)");
  } else {
    console.warn("‚ö†Ô∏è playerData.records missing or not array", playerData);
  }

  console.log("DEBUG players:", Object.keys(playerMap).length);
  const nightStatus = document.getElementById("night-status");
  const matchDiv = document.getElementById("matches");

  // 2Ô∏è‚É£ handle no-night case
  if (!nightData.records || !nightData.records.length) {
    nightStatus.innerHTML = "<h2>No Game Night in progress üé≤</h2><p>Enjoy the leaderboard below!</p>";
    matchDiv.innerHTML = "";
    return;
  }

  const night = nightData.records[0];
  nightStatus.innerHTML = `<h2>üéÆ Game Night: ${night.fields?.date || "Today"}</h2>
    <p>Status: <span style="background:#ffc107;color:#222;padding:4px 10px;border-radius:6px;">In Progress</span></p>`;

  // 3Ô∏è‚É£ safely filter matches linked to this night
  const matches = (Array.isArray(matchData.records) ? matchData.records : []).filter(m => {
    const linked = m.fields?.nights || [];
    return linked.some(v => (typeof v === "string" ? v === night.id : v.id === night.id));
  });
  console.log("DEBUG matches:", matches.length, "records found for night", night.id);

  if (!matches.length) {
    matchDiv.innerHTML = "<p>No matches found for this night.</p>";
    return;
  }

  // 4Ô∏è‚É£ build fun colorful grid
  matchDiv.innerHTML = '<h2>üî• Matchups</h2><div class="match-grid"></div>';
  const grid = document.querySelector(".match-grid");
  matches.forEach((m, i) => {
    const f = m.fields || {};
    const color = COLORS[i % COLORS.length];
    const teamA = [f.teamA1, f.teamA2].map(id => playerMap[id] || "").filter(Boolean).join(" & ") || "Team A";
    const teamB = [f.teamB1, f.teamB2].map(id => playerMap[id] || "").filter(Boolean).join(" & ") || "Team B";
    const status = f.status || "pending";
    const winner = f.winner || "‚è≥";
    const glow = status === "complete" ? `0 0 20px ${color}` : "0 0 10px rgba(0,0,0,0.5)";
    grid.insertAdjacentHTML(
      "beforeend",
      `<div class="match-card" style="border-color:${color};box-shadow:${glow};">
        <div class="team-name" style="color:${color};">${teamA}</div>
        <div class="vs">vs</div>
        <div class="team-name" style="color:${color};">${teamB}</div>
        <div class="status">${status === "complete" ? "üèÅ Winner: " + winner : "‚è≥ " + status}</div>
      </div>`
    );
  });
}

    async function refresh() {
      await loadGameNight();
      await loadLeaderboard();
    }

    refresh();
    setInterval(refresh, 30000);
  </script>
</body>
</html>
